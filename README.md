# DevOps Тестовое Задание

---

## Описание

Этот проект автоматизирует настройку двух серверов (`A` и `B`) с использованием `Ansible`. Задачи включают:

- Отключение авторизации `SSH` по паролю и настройка авторизации по ключам.
- Создание пользователя `devops` с правами `sudo` без ввода пароля.
- Установка и настройка `fail2ban` на сервере `A`.
- Установка и настройка `PostgreSQL` на сервере `A` с созданием баз данных и пользователей.
- Установка и настройка `nginx` на сервере `B` для проксирования запросов на `https://renue.ru`.
- Настройка правил брандмауэра для управления доступом между серверами.
- Настройка бэкапов с сервера `A` на сервер `B`.

Этот документ описывает шаги для подготовки окружения и запуска плейбука, а также решает вопрос управления `SSH`-доступом при отключении авторизации по паролю.

---

## Требования

- **Ansible**: Установлен на управляющей машине (той, с которой запускается плейбук).
- **SSH-доступ**: Изначально доступ к серверам должен быть настроен с использованием пароля.
- **Права root или sudo**: Для выполнения задач настройки.

---

## Подготовка к запуску

### 1. Создание папки для SSH-ключей
Перед запуском плейбука необходимо создать папку `ssh` в корневой директории проекта и подготовить `SSH`-ключи:

- Создайте директорию:
  ```
  mkdir ssh
- Сгенерируйте пару `SSH`-ключей:
  ```
  ssh-keygen -t rsa -b 4096 -f ssh/id_rsa
Это создаст приватный ключ `ssh/id_rsa` и публичный ключ `ssh/id_rsa.pub`, которые будут использоваться в плейбуке.

### 2. Настройка инвентаря
Отредактируйте файл `inventory.ini`, указав правильные `IP-адреса` серверов `A` и `B`, а также имена пользователей для первоначального подключения. Пример:

```
[server_a]
hosta ansible_host=192.168.1.10 ansible_user=initial_user

[server_b]
hostb ansible_host=192.168.1.11 ansible_user=initial_user
```
### 3. Проверка конфигурации Ansible
Файл `ansible.cfg` уже настроен для использования ключей из директории `ssh` и указанного инвентаря.
Запуск плейбука
Первый запуск
На первом этапе серверы должны быть доступны по паролю, чтобы `Ansible` могла подключиться и настроить ключи. Выполните следующую команду:

```
ansible-playbook playbook.yml --ask-pass --ask-become-pass
```
`--ask-pass`: Запрашивает пароль для SSH-подключения.
`--ask-become-pass`: Запрашивает пароль для выполнения команд с правами sudo.
Во время этого запуска плейбук выполнит следующие действия:

Создаст пользователя `devops`.
Добавит публичный ключ `ssh/id_rsa.pub` в файл `~/.ssh/authorized_keys` пользователя `devops`.
Отключит авторизацию по паролю в конфигурации `SSH`.
Перезапустит службу `SSH`.
Авторизация по `SSH-ключам`. Процесс включает следующие шаги:
Изначальное подключение: На первом этапе подключение к серверам осуществляется по паролю, чтобы `Ansible` могла выполнить начальную настройку.
Настройка ключей: Плейбук добавляет сгенерированный `SSH-ключ` (`ssh/id_rsa.pub`) в файл `~/.ssh/authorized_keys` пользователя `devops` на обоих серверах.
Отключение пароля: После успешной настройки ключей авторизация по паролю отключается в файле `/etc/ssh/sshd_config` параметром` PasswordAuthentication no`.
Проверка: Плейбук проверяет возможность подключения по ключу перед отключением пароля.
Последующий доступ: После выполнения плейбука подключение к серверам возможно только с использованием приватного ключа `ssh/id_rsa`.
Пример:
```
ssh -i ssh/id_rsa devops@192.168.0.116
```
Таким образом, процесс полностью автоматизирован:

Первый запуск требует пароля для настройки.
После этого доступ возможен только по ключу, что повышает безопасность.
Дополнительные настройки
Бэкапы
Бэкапы с сервера `A` на сервер `B` настроены с использованием `rsync` по `SSH`.
На сервере `A` для пользователя `postgres` генерируется отдельный `SSH-ключ`, который добавляется в `~/.ssh/authorized_keys` пользователя `devops` на сервере B.
Это обеспечивает безопасную передачу данных без ввода пароля.
Правила брандмауэра
Плейбук настраивает `UFW` для управления трафиком:

Разрешен `SSH` на обоих серверах.
Сервер `A`: Разрешен доступ к `PostgreSQL` (порт `5432`) только с сервера `B`.
Сервер `B`: Разрешены `HTTP` (порт `80`) и `HTTPS` (порт `443`), доступ с сервера `A` 

Одним из ключевых преимуществ выбора `Ansible` является то, что он позволяет управлять серверами и инфраструктурой без необходимости установки дополнительных агентов на целевые машины. В отличие от таких инструментов, как `Puppet` или `Chef`, которые требуют наличия агентов на каждом сервере для выполнения задач, `Ansible` использует модель "`push`", отправляя команды через `SSH` (или `WinRM` для `Windows`). Это обеспечивает следующие выгоды:

- **Простота настройки**: Вам не нужно тратить время на установку и конфигурацию агентов на каждом сервере, что значительно упрощает процесс начальной настройки и управления.
- **Экономия ресурсов**: Агенты, работающие на серверах, могут потреблять CPU, память и дисковое пространство, тогда как `Ansible` позволяет избежать этих затрат.
- **Повышенная безопасность**: Меньше программного обеспечения на сервере означает меньше потенциальных уязвимостей, которые могут быть использованы злоумышленниками.
- **Скорость внедрения**: Вы можете начать использовать `Ansible` сразу после настройки управляющего узла, без дополнительных шагов по развертыванию агентов.

Таким образом, отсутствие необходимости в агентах делает `Ansible` удобным, эффективным и экономичным решением для автоматизации управления конфигурациями и развёртывания приложений.